name: Lighthouse Audit

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  audit:
    runs-on: ubuntu-latest
    name: Run Lighthouse Audit

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Lighthouse and dependencies
        run: |
          npm install -g lighthouse@12.2.0
          npm install -g serve

      - name: Start local server
        run: |
          nohup serve . -l 8080 &
          sleep 5

      - name: Run Lighthouse Audit
        run: |
          lighthouse http://localhost:8080 \
            --output html \
            --output-path ./lighthouse-report.html \
            --quiet \
            --chrome-flags="--headless" \
            --only-categories=performance,accessibility,best-practices,seo \
            --preset=desktop

      - name: Parse scores and fail if below threshold
        run: |
          # Extract scores from Lighthouse JSON output (we generate JSON too)
          lighthouse http://localhost:8080 \
            --output json \
            --output-path ./lighthouse-report.json \
            --quiet \
            --chrome-flags="--headless"

          PERFORMANCE=$(jq '.categories.performance.score * 100' ./lighthouse-report.json)
          ACCESSIBILITY=$(jq '.categories.accessibility.score * 100' ./lighthouse-report.json)
          BESTPRACTICES=$(jq '.categories["best-practices"].score * 100' ./lighthouse-report.json)
          SEO=$(jq '.categories.seo.score * 100' ./lighthouse-report.json)

          echo "Performance: $PERFORMANCE"
          echo "Accessibility: $ACCESSIBILITY"
          echo "Best Practices: $BESTPRACTICES"
          echo "SEO: $SEO"

          # Fail build if scores are below threshold
          if (( $(echo "$PERFORMANCE < 80" | bc -l) )) || \
             (( $(echo "$ACCESSIBILITY < 80" | bc -l) )) || \
             (( $(echo "$BESTPRACTICES < 80" | bc -l) )) || \
             (( $(echo "$SEO < 80" | bc -l) )); then
            echo "❌ Lighthouse score(s) below threshold!"
            exit 1
          fi

      - name: Upload Lighthouse Reports
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-reports
          path: |
            ./lighthouse-report.html
            ./lighthouse-report.json
